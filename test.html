<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Test - Campaign AI Editor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .timestamp-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            padding: 15px;
            background: #e8f4fd;
            border-left: 5px solid #007acc;
            border-radius: 5px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-pending { background-color: #ff9800; }
        .data-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .refresh-counter {
            font-size: 18px;
            color: #666;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007acc;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Backend Test - Campaign AI Editor</h1>
        <p><strong>Requirement 1.1:</strong> Basic Backend-Frontend Communication</p>

        <!-- Live Timestamp Display -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="timestamp-status"></span>Live Timestamp Test</h3>
            <div class="timestamp-display" id="live-timestamp">Connecting to backend...</div>
            <div class="refresh-counter" id="refresh-counter">Refresh count: 0</div>
            <p><strong>Expected:</strong> Timestamp should update every 2 seconds proving no caching</p>
        </div>

        <!-- API Response Display -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="api-status"></span>Backend API Response</h3>
            <div class="data-display" id="api-response">Waiting for data...</div>
            <button class="btn-primary" onclick="fetchOnce()">Fetch Once</button>
            <button class="btn-secondary" onclick="toggleAutoRefresh()">Toggle Auto-Refresh</button>
        </div>

        <!-- Cache Test -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="cache-status"></span>Cache Verification</h3>
            <div id="cache-test">
                <p><strong>Random Value:</strong> <span id="cache-value">-</span></p>
                <p><strong>Previous Value:</strong> <span id="prev-cache-value">-</span></p>
                <p><strong>Cache Status:</strong> <span id="cache-result">Testing...</span></p>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-section">
            <h3>Test Controls</h3>
            <button class="btn-primary" onclick="runCacheTest()">Run Cache Test</button>
            <button class="btn-secondary" onclick="clearDisplay()">Clear Display</button>
            <button class="btn-secondary" onclick="location.reload()">Reload Page</button>
        </div>
    </div>

    <script>
        let refreshCount = 0;
        let autoRefreshEnabled = true;
        let lastCacheValue = null;
        let refreshInterval;

        // Update displays
        function updateTimestamp(data) {
            document.getElementById('live-timestamp').textContent =
                `${data.readable} (${data.timestamp})`;
            document.getElementById('refresh-counter').textContent =
                `Refresh count: ${++refreshCount}`;
        }

        function updateApiResponse(data) {
            document.getElementById('api-response').textContent =
                JSON.stringify(data, null, 2);
        }

        function updateCacheTest(data) {
            const currentValue = data.cacheTest;
            const cacheValueSpan = document.getElementById('cache-value');
            const prevValueSpan = document.getElementById('prev-cache-value');
            const resultSpan = document.getElementById('cache-result');

            cacheValueSpan.textContent = currentValue;

            if (lastCacheValue !== null) {
                prevValueSpan.textContent = lastCacheValue;
                if (currentValue !== lastCacheValue) {
                    resultSpan.textContent = '✅ No caching detected';
                    resultSpan.style.color = 'green';
                    document.getElementById('cache-status').className = 'status-indicator status-success';
                } else {
                    resultSpan.textContent = '❌ Possible caching detected';
                    resultSpan.style.color = 'red';
                    document.getElementById('cache-status').className = 'status-indicator status-error';
                }
            }
            lastCacheValue = currentValue;
        }

        // Fetch data from backend
        async function fetchData() {
            try {
                const response = await fetch('/api/status?t=' + Date.now());
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                updateTimestamp(data);
                updateApiResponse(data);
                updateCacheTest(data);

                // Update status indicators
                document.getElementById('timestamp-status').className = 'status-indicator status-success';
                document.getElementById('api-status').className = 'status-indicator status-success';

                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('live-timestamp').textContent = 'Error: ' + error.message;
                document.getElementById('api-response').textContent = 'Error fetching data: ' + error.message;

                // Update status indicators to error
                document.getElementById('timestamp-status').className = 'status-indicator status-error';
                document.getElementById('api-status').className = 'status-indicator status-error';
            }
        }

        // Manual fetch
        function fetchOnce() {
            fetchData();
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                clearInterval(refreshInterval);
            }
        }

        // Start auto-refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(fetchData, 2000); // Every 2 seconds
        }

        // Cache test
        function runCacheTest() {
            fetchData().then(() => {
                setTimeout(fetchData, 100); // Quick second fetch to test caching
            });
        }

        // Clear display
        function clearDisplay() {
            refreshCount = 0;
            lastCacheValue = null;
            document.getElementById('live-timestamp').textContent = 'Display cleared';
            document.getElementById('api-response').textContent = 'Display cleared';
            document.getElementById('refresh-counter').textContent = 'Refresh count: 0';
            document.getElementById('cache-value').textContent = '-';
            document.getElementById('prev-cache-value').textContent = '-';
            document.getElementById('cache-result').textContent = 'Testing...';
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('🧪 Backend Test Page Loaded');
            console.log('📡 Starting communication test with backend...');

            // Initial fetch
            fetchData();

            // Start auto-refresh
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>